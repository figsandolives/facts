<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title data-i18n="catalog_title">عرض المنتجات</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <!-- تم حذف مكتبة html5-qrcode -->
</head>

<body class="bg-slate-50 text-slate-900">
  <header class="sticky top-0 z-40 bg-white border-b">
    <div class="max-w-7xl mx-auto px-4 py-4 flex flex-wrap items-center gap-2">
      <h1 class="text-xl font-bold" data-i18n="catalog_title">عرض المنتجات</h1>

      <div class="ms-auto flex flex-wrap items-center gap-2">
        <button id="langToggle" class="px-3 py-2 rounded-lg border bg-white hover:bg-slate-50">EN</button>

        <input id="search" class="w-64 max-w-full rounded-lg border px-3 py-2 bg-white"
          data-i18n-ph="search_ph" placeholder="بحث عن منتج..." />

        <!-- فلتر النظام الغذائي الجديد -->
        <select id="filterDiet" class="rounded-lg border px-3 py-2 bg-white">
          <option value="" data-i18n="diet_all">النظام الغذائي (الكل)</option>
        </select>

        <select id="filterMain" class="rounded-lg border px-3 py-2 bg-white">
          <option value="" data-i18n="main_all">القسم الرئيسي (الكل)</option>
        </select>

        <select id="filterSub" class="rounded-lg border px-3 py-2 bg-white">
          <option value="" data-i18n="sub_all">القسم الفرعي (الكل)</option>
        </select>

        <button id="btnClear" class="px-3 py-2 rounded-lg border bg-white hover:bg-slate-50" data-i18n="clear_filters">
          إلغاء الفرز
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <div id="status" class="text-sm text-slate-600 mb-4"></div>

    <div id="grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3"></div>
  </main>

  <!-- تم حذف مودال الماسح الضوئي (Scanner Modal) -->

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, query, orderBy, onSnapshot, doc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAcIwwapktH2nxyZczVKFacTrLh1o-EgdM",
      authDomain: "shakkak-8f90f.firebaseapp.com",
      databaseURL: "https://shakkak-8f90f-default-rtdb.firebaseio.com",
      projectId: "shakkak-8f90f",
      storageBucket: "shakkak-8f90f.firebasestorage.app",
      messagingSenderId: "1039276785290",
      appId: "1:1039276785290:web:9523f9e1ddf7db7410f773",
      measurementId: "G-XFGQ90337E"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ===== i18n =====
    const dict = {
      ar: {
        catalog_title: "عرض المنتجات",
        search_ph: "بحث عن منتج...",
        diet_all: "النظام الغذائي (الكل)", // جديد
        main_all: "القسم الرئيسي (الكل)",
        sub_all: "القسم الفرعي (الكل)",
        clear_filters: "إلغاء الفرز",
        price: "السعر",
        currency: "KD",
        count: "عدد المنتجات",
        not_found: "المنتج غير موجود",
        open_product: "فتح المنتج"
      },
      en: {
        catalog_title: "Products",
        search_ph: "Search product...",
        diet_all: "Diet Category (All)", // جديد
        main_all: "Main section (All)",
        sub_all: "Sub section (All)",
        clear_filters: "Clear filters",
        price: "Price",
        currency: "KD",
        count: "Products",
        not_found: "Product not found",
        open_product: "Open product"
      }
    };

    let lang = localStorage.getItem("lang") || "ar";
    const langToggle = document.getElementById("langToggle");

    function applyLang(){
      document.documentElement.lang = lang;
      document.documentElement.dir = (lang === "ar") ? "rtl" : "ltr";
      langToggle.textContent = (lang === "ar") ? "EN" : "AR";

      document.querySelectorAll("[data-i18n]").forEach(el=>{
        const k = el.getAttribute("data-i18n");
        if (dict[lang][k]) el.textContent = dict[lang][k];
      });
      document.querySelectorAll("[data-i18n-ph]").forEach(el=>{
        const k = el.getAttribute("data-i18n-ph");
        if (dict[lang][k]) el.setAttribute("placeholder", dict[lang][k]);
      });
    }

    langToggle.addEventListener("click", ()=>{
      lang = (lang === "ar") ? "en" : "ar";
      localStorage.setItem("lang", lang);
      applyLang();
      render();
      rebuildSelects(); // update placeholders
    });

    applyLang();

    // ===== UI refs =====
    const grid = document.getElementById("grid");
    const status = document.getElementById("status");
    const search = document.getElementById("search");
    const filterDiet = document.getElementById("filterDiet"); // جديد
    const filterMain = document.getElementById("filterMain");
    const filterSub = document.getElementById("filterSub");
    const btnClear = document.getElementById("btnClear");


    // ===== data =====
    let items = [];
    // تحديث metaCache لجلب فئات النظام الغذائي
    let metaCache = { dietCategories: [], mainSections: [], subSections: [] }; 

    const metaRef = (name)=> doc(db, "meta", name);
    async function loadMeta(){
      // جلب جميع فئات الميتا
      const [dSnap, mSnap, sSnap] = await Promise.all([
        getDoc(metaRef("dietCategories")), // جلب فئات النظام الغذائي
        getDoc(metaRef("mainSections")),
        getDoc(metaRef("subSections"))
      ]);
      metaCache.dietCategories = dSnap.exists() ? (dSnap.data().items || []) : []; // حفظ
      metaCache.mainSections = mSnap.exists() ? (mSnap.data().items || []) : [];
      metaCache.subSections = sSnap.exists() ? (sSnap.data().items || []) : [];
    }

    function fillSelect(select, itemsList, phText){
      const current = select.value;
      select.innerHTML = "";
      const ph = document.createElement("option");
      ph.value = "";
      ph.textContent = phText;
      select.appendChild(ph);

      itemsList.forEach(v=>{
        const o = document.createElement("option");
        o.value = v;
        o.textContent = v;
        select.appendChild(o);
      });

      // الحفاظ على القيمة المختارة إن وجدت
      if ([...select.options].some(o=>o.value===current)) select.value = current;
      else select.value = "";
    }

    function rebuildSelects(){
      // 1. إعادة بناء فلتر النظام الغذائي (يعرض جميع الفئات المتاحة)
      fillSelect(filterDiet, metaCache.dietCategories, dict[lang].diet_all);
      
      // 2. إعادة بناء فلتر القسم الرئيسي (يعرض جميع الأقسام المتاحة)
      fillSelect(filterMain, metaCache.mainSections, dict[lang].main_all);

      // 3. إعادة بناء فلتر القسم الفرعي (يعتمد على فلتر القسم الرئيسي وفلتر النظام الغذائي)
      let base = items;

      // تطبيق فلتر القسم الرئيسي
      if (filterMain.value) {
        base = base.filter(p => p.mainSection === filterMain.value);
      }
      
      // تطبيق فلتر النظام الغذائي (افتراض: dietCategory حقل مصفوفة يحتوي الفئات)
      if (filterDiet.value) {
        base = base.filter(p => (p.dietCategory || []).includes(filterDiet.value));
      }
      
      // استخراج الأقسام الفرعية الفريدة من المنتجات المفلترة
      const relevantSubSections = base.map(p=>p.subSection).filter(Boolean);
      const uniq = [...new Set(relevantSubSections)].sort((a,b)=>a.localeCompare(b, "ar"));
      
      fillSelect(filterSub, uniq, dict[lang].sub_all);
    }

    function applyFilters(){
      const q = (search.value||"").trim().toLowerCase();
      const diet = filterDiet.value; // جلب قيمة فلتر النظام الغذائي
      const main = filterMain.value;
      const sub = filterSub.value;

      let out = items.slice();
      if (q) {
        out = out.filter(p =>
          (p.nameAr||"").toLowerCase().includes(q) ||
          (p.nameEn||"").toLowerCase().includes(q)
        );
      }
      // تطبيق فلتر النظام الغذائي
      if (diet) out = out.filter(p => (p.dietCategory || []).includes(diet));
      
      if (main) out = out.filter(p => p.mainSection === main);
      if (sub) out = out.filter(p => p.subSection === sub);

      return out;
    }

    function productName(p){
      return lang === "ar" ? (p.nameAr || "") : (p.nameEn || "");
    }

    function render(){
      const out = applyFilters();
      status.textContent = `${dict[lang].count}: ${out.length}`;

      grid.innerHTML = "";
      out.forEach(p=>{
        const a = document.createElement("a");
        a.href = `product.html?id=${encodeURIComponent(p.id)}`;
        a.className = "block rounded-2xl border bg-white overflow-hidden hover:shadow-md transition";

        const priceLine = `${dict[lang].price}: ${p.price || ""} ${dict[lang].currency}`;

        a.innerHTML = `
          <div class="aspect-square bg-slate-100">
            <img src="${p.imageUrl||"https://placehold.co/400x400/e2e8f0/475569?text=Product"}" class="w-full h-full object-cover" alt="صورة المنتج">
          </div>
          <div class="p-3">
            <div class="font-semibold line-clamp-2">${productName(p)}</div>
            <div class="text-xs text-slate-500 mt-1">${lang==="ar" ? (p.nameEn||"") : (p.nameAr||"")}</div>
            <div class="mt-2 text-sm">${priceLine}</div>
          </div>
        `;
        grid.appendChild(a);
      });

      rebuildSelects();
    }

    // Live products
    const productsCol = collection(db, "products");
    const qRef = query(productsCol, orderBy("createdAt", "desc"));

    // تحميل البيانات الوصفية قبل الاستماع لبيانات المنتجات
    await loadMeta();

    onSnapshot(qRef, (snap)=>{
      items = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      render();
    });

    // إضافة فلتر النظام الغذائي إلى مستمعي الأحداث
    [search, filterDiet, filterMain, filterSub].forEach(el=>{
      el.addEventListener("input", render);
      el.addEventListener("change", render);
    });

    // تحديث زر إلغاء الفرز لمسح فلتر النظام الغذائي أيضاً
    btnClear.addEventListener("click", ()=>{
      search.value = "";
      filterDiet.value = ""; 
      filterMain.value = "";
      filterSub.value = "";
      render();
    });

    // تم حذف جميع أكواد الماسح الضوئي (Scanner)
  </script>
</body>
</html>
